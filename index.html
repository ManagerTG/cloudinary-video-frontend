<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Video Uploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    :root {
      --bg: #0a0e1a;
      --panel: #131a2e;
      --border: #1f2937;
      --accent: #22c55e;
      --accent-dark: #16a34a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #0a0e1a 0%, #020617 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
    }
    
    header {
      padding: 14px 16px;
      background: rgba(19, 26, 46, 0.95);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    header h1 {
      font-size: 1.1rem;
      margin-bottom: 2px;
    }
    .subtitle {
      font-size: 0.72rem;
      color: var(--muted);
    }
    .chip {
      position: absolute;
      top: 14px;
      right: 16px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #0f172a;
      color: var(--muted);
    }

    #lockView {
      padding: 40px 20px;
      text-align: center;
      max-width: 400px;
      margin: 60px auto;
    }
    #lockView h2 { font-size: 1.2rem; margin-bottom: 8px; }
    #lockView p { font-size: 0.85rem; color: var(--muted); margin-bottom: 20px; }
    #lockView input {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      font-size: 1rem;
      margin-bottom: 12px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 12px;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(19, 26, 46, 0.98);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
      z-index: 100;
    }
    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 4px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 0.7rem;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .nav-btn.active { color: var(--accent); }
    .nav-icon { font-size: 1.4rem; }

    .content {
      padding-bottom: 80px;
    }
    section { display: none; }
    section.active { display: block; }

    .card {
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 16px;
      margin-bottom: 12px;
    }
    .card h3 { font-size: 0.95rem; margin-bottom: 6px; }
    .card p { font-size: 0.78rem; color: var(--muted); margin-bottom: 10px; }

    label {
      font-size: 0.8rem;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }
    input[type="file"] {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0a0e1a;
      color: var(--text);
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 12px 18px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      width: 100%;
      transition: transform 0.1s ease, opacity 0.15s ease;
    }
    .btn-main {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #022c22;
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
    }
    .btn-secondary {
      background: #1f2937;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-danger {
      background: #7f1d1d;
      color: #fee2e2;
      border: 1px solid #b91c1c;
    }
    .btn-warning {
      background: #78350f;
      color: #fef3c7;
      border: 1px solid #92400e;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn:active:not(:disabled) { transform: scale(0.98); }

    .btn-group {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .btn-group .btn { flex: 1; }

    .status-box {
      background: #0a0e1a;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 12px;
      margin-top: 10px;
    }
    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 0.8rem;
    }
    .badge {
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.72rem;
      background: #0f172a;
      color: var(--muted);
    }
    .progress {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      margin: 8px 0;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-dark));
      transition: width 0.3s ease-out;
    }
    .usage-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid var(--border);
      margin: 8px 0;
    }
    .usage-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #38bdf8, #22c55e);
      transition: width 0.3s ease-out;
    }

    .log {
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.78rem;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }
    .log-item {
      margin-bottom: 6px;
      padding: 6px;
      background: #0a0e1a;
      border-radius: 6px;
    }
    .log-url {
      word-break: break-all;
      color: #38bdf8;
      text-decoration: none;
      font-size: 0.72rem;
    }

    .video-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .video-item {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: #0a0e1a;
      border-radius: 10px;
      margin-bottom: 8px;
      align-items: center;
    }
    .video-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }
    .video-thumb {
      width: 80px;
      height: 45px;
      border-radius: 6px;
      overflow: hidden;
      background: #020617;
      flex-shrink: 0;
    }
    .video-thumb video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .video-info {
      flex: 1;
      font-size: 0.75rem;
    }
    .video-info .size {
      color: var(--accent);
      font-weight: 600;
    }
    .video-info .date {
      color: var(--muted);
      margin-top: 2px;
    }

    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .text-muted { color: var(--muted); font-size: 0.72rem; margin-top: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>Video Uploader</h1>
    <p class="subtitle">Upload to Cloudinary (Reels folder)</p>
    <span class="chip" id="authChip">Locked</span>
  </header>

  <div id="lockView">
    <h2>üîê Enter Access Code</h2>
    <p>This site is private. Enter your daily access code.</p>
    <input id="accessInput" type="password" placeholder="Access code" />
    <button id="unlockBtn" class="btn btn-main">Unlock</button>
    <p class="text-muted">You stay unlocked for 24 hours on this device.</p>
  </div>

  <div id="appView" class="hidden">
    <div class="container content">
      
      <section id="uploadTab" class="active">
        <div class="card">
          <label for="fileInput">Select videos to upload</label>
          <input id="fileInput" type="file" accept="video/*" multiple />
          
          <div class="btn-group">
            <button id="uploadBtn" class="btn btn-main">‚¨Ü Upload</button>
            <button id="statsBtn" class="btn btn-secondary">‚Ñπ Stats</button>
          </div>

          <div class="status-box">
            <div class="status-row">
              <span id="statusText">Ready. Select videos.</span>
              <span id="counterBadge" class="badge">0 / 0</span>
            </div>
            <div class="progress">
              <div id="progressBar" class="progress-bar"></div>
            </div>
            <p class="text-muted">Browser uploaded: <span id="browserTotal">0</span> videos</p>
          </div>

          <div class="log" id="log"></div>
        </div>
      </section>

      <section id="usageTab">
        <div class="card">
          <h3>üìä Storage Usage</h3>
          <p>Shows your Cloudinary storage used (free 25 GB plan).</p>
          <button id="refreshUsageBtn" class="btn btn-secondary">üîÑ Refresh usage</button>
          <div class="status-box">
            <p id="usageText" style="font-size:0.8rem;margin-bottom:6px;">Usage not loaded yet.</p>
            <div class="usage-bar">
              <div id="usageFill" class="usage-fill"></div>
            </div>
          </div>
        </div>
      </section>

      <section id="manageTab">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3>üóÇ Manage Videos</h3>
            <button id="reloadVideosBtn" class="btn btn-secondary" style="width:auto;padding:8px 14px;">Reload</button>
          </div>
          <p>Select videos and delete from Cloudinary (cannot be undone).</p>
          
          <div style="margin-bottom:8px;">
            <label style="display:inline-flex;align-items:center;gap:6px;margin-bottom:8px;">
              <input type="checkbox" id="selectAllChk" style="width:18px;height:18px;" />
              <span style="font-size:0.8rem;">Select all</span>
            </label>
          </div>

          <div class="btn-group" style="margin-bottom:10px;">
            <button id="deleteSelectedBtn" class="btn btn-danger">üóë Delete selected</button>
            <button id="deleteOldBtn" class="btn btn-warning">‚è∞ Delete 7+ days old</button>
          </div>

          <div class="video-list" id="videoList"></div>
        </div>
      </section>

    </div>

    <nav class="bottom-nav">
      <button class="nav-btn active" data-tab="uploadTab">
        <span class="nav-icon">‚¨Ü</span>
        <span>Upload</span>
      </button>
      <button class="nav-btn" data-tab="usageTab">
        <span class="nav-icon">üìä</span>
        <span>Usage</span>
      </button>
      <button class="nav-btn" data-tab="manageTab">
        <span class="nav-icon">üóÇ</span>
        <span>Manage</span>
      </button>
    </nav>
  </div>

  <script>
    const CLOUD_NAME = "dfnvpi7nh";
    const UPLOAD_PRESET = "telegram_upload";
    const BACKEND_BASE_URL = "https://cloudinary-video-backend.onrender.com";
    const ACCESS_CODE = "912734";
    const UNLOCK_HOURS = 24;
    const STORAGE_LIMIT_GB = 25;

    const lockView = document.getElementById("lockView");
    const appView = document.getElementById("appView");
    const accessInput = document.getElementById("accessInput");
    const unlockBtn = document.getElementById("unlockBtn");
    const authChip = document.getElementById("authChip");

    function isUnlocked() {
      const raw = localStorage.getItem("cvd_unlock");
      if (!raw) return false;
      try {
        const obj = JSON.parse(raw);
        const diffH = (Date.now() - obj.ts) / (1000 * 60 * 60);
        return diffH < UNLOCK_HOURS;
      } catch { return false; }
    }

    function setUnlocked() {
      localStorage.setItem("cvd_unlock", JSON.stringify({ ts: Date.now() }));
    }

    function updateAuthView() {
      if (isUnlocked()) {
        lockView.classList.add("hidden");
        appView.classList.remove("hidden");
        authChip.textContent = "Unlocked";
      } else {
        lockView.classList.remove("hidden");
        appView.classList.add("hidden");
        authChip.textContent = "Locked";
      }
    }

    unlockBtn.addEventListener("click", () => {
      const val = accessInput.value.trim();
      if (!val) return alert("Enter code.");
      if (val === ACCESS_CODE) {
        setUnlocked();
        updateAuthView();
        accessInput.value = "";
      } else {
        alert("Wrong code.");
      }
    });

    updateAuthView();

    const navBtns = document.querySelectorAll(".nav-btn");
    const sections = {
      uploadTab: document.getElementById("uploadTab"),
      usageTab: document.getElementById("usageTab"),
      manageTab: document.getElementById("manageTab")
    };

    navBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.tab;
        Object.keys(sections).forEach(k => {
          sections[k].classList.toggle("active", k === target);
        });
        navBtns.forEach(b => b.classList.toggle("active", b === btn));
      });
    });

    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const statsBtn = document.getElementById("statsBtn");
    const statusText = document.getElementById("statusText");
    const counterBadge = document.getElementById("counterBadge");
    const progressBar = document.getElementById("progressBar");
    const log = document.getElementById("log");
    const browserTotalEl = document.getElementById("browserTotal");

    const LS_KEY = "video_uploader_total";
    let browserTotal = parseInt(localStorage.getItem(LS_KEY) || "0", 10);
    browserTotalEl.textContent = browserTotal;

    function saveBrowserTotal() {
      localStorage.setItem(LS_KEY, String(browserTotal));
      browserTotalEl.textContent = browserTotal;
    }

    function logMessage(text, url, ok = true) {
      const item = document.createElement("div");
      item.className = "log-item";
      const icon = ok ? "‚úÖ" : "‚ùå";
      item.innerHTML = `
        <div>${icon} ${text}</div>
        ${url ? `<a class="log-url" href="${url}" target="_blank">${url}</a>` : ""}
      `;
      log.prepend(item);
    }

    async function uploadSingleFile(file, index, total) {
      const endpoint = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);
      statusText.textContent = `Uploading ${index + 1}/${total}: ${file.name.slice(0, 20)}...`;

      try {
        const res = await fetch(endpoint, { method: "POST", body: formData });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        logMessage(`${file.name}`, data.secure_url, true);
        browserTotal += 1;
        saveBrowserTotal();
        return true;
      } catch (err) {
        logMessage(`${file.name} failed`, null, false);
        return false;
      }
    }

    uploadBtn.addEventListener("click", async () => {
      const files = fileInput.files;
      if (!files || !files.length) return alert("Select videos.");

      const total = files.length;
      let okCount = 0;
      uploadBtn.disabled = true;
      statsBtn.disabled = true;
      counterBadge.textContent = `0 / ${total}`;
      progressBar.style.width = "0%";

      for (let i = 0; i < total; i++) {
        const ok = await uploadSingleFile(files[i], i, total);
        if (ok) okCount++;
        progressBar.style.width = `${Math.round(((i + 1) / total) * 100)}%`;
        counterBadge.textContent = `${okCount} / ${total}`;
      }

      statusText.textContent =
        okCount === total ? `All done (${okCount}/${total})` : `Done with errors (${okCount}/${total})`;
      uploadBtn.disabled = false;
      statsBtn.disabled = false;
    });

    statsBtn.addEventListener("click", async () => {
      try {
        const res = await fetch(`${BACKEND_BASE_URL}/stats`);
        const data = await res.json();
        if (typeof data.total === "number") {
          alert(`Cloud total: ${data.total} videos\nBrowser uploaded: ${browserTotal}`);
        }
      } catch (e) {
        alert("Failed to load stats.");
      }
    });

    const refreshUsageBtn = document.getElementById("refreshUsageBtn");
    const usageText = document.getElementById("usageText");
    const usageFill = document.getElementById("usageFill");

    refreshUsageBtn.addEventListener("click", async () => {
      refreshUsageBtn.disabled = true;
      try {
        const res = await fetch(`${BACKEND_BASE_URL}/usage`);
        const data = await res.json();
        const used = data.storageGB || 0;
        const limit = data.limitGB || STORAGE_LIMIT_GB;
        const percent = Math.min(100, (used / limit) * 100);
        usageFill.style.width = `${percent.toFixed(1)}%`;
        const left = Math.max(0, limit - used);
        usageText.textContent =
          `Used ${used.toFixed(2)} GB of ${limit} GB (${percent.toFixed(1)}%). Left: ${left.toFixed(2)} GB.`;
      } catch (e) {
        alert("Failed to load usage.");
      } finally {
        refreshUsageBtn.disabled = false;
      }
    });

    const videoList = document.getElementById("videoList");
    const reloadVideosBtn = document.getElementById("reloadVideosBtn");
    const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
    const deleteOldBtn = document.getElementById("deleteOldBtn");
    const selectAllChk = document.getElementById("selectAllChk");

    let allVideos = []; // store loaded videos globally

    function formatBytes(b) {
      const mb = b / (1024 * 1024);
      return `${mb.toFixed(1)} MB`;
    }

    function renderVideos(videos) {
      allVideos = videos; // save for bulk actions
      videoList.innerHTML = "";
      videos.forEach(v => {
        const div = document.createElement("div");
        div.className = "video-item";
        div.dataset.created = v.created_at; // store timestamp for filtering
        div.innerHTML = `
          <input type="checkbox" class="rowChk" data-id="${v.public_id}" />
          <div class="video-thumb">
            <video src="${v.secure_url}" muted></video>
          </div>
          <div class="video-info">
            <div class="size">${formatBytes(v.bytes)}</div>
            <div class="date">${v.created_at ? v.created_at.slice(0, 16).replace("T", " ") : ""}</div>
          </div>
        `;
        videoList.appendChild(div);
      });
    }

    reloadVideosBtn.addEventListener("click", async () => {
      reloadVideosBtn.disabled = true;
      try {
        const res = await fetch(`${BACKEND_BASE_URL}/videos`);
        const data = await res.json();
        renderVideos(data.videos || []);
      } catch (e) {
        alert("Failed to load videos.");
      } finally {
        reloadVideosBtn.disabled = false;
        selectAllChk.checked = false;
      }
    });

    selectAllChk.addEventListener("change", () => {
      document.querySelectorAll(".rowChk").forEach(c => (c.checked = selectAllChk.checked));
    });

    deleteSelectedBtn.addEventListener("click", async () => {
      const chks = Array.from(document.querySelectorAll(".rowChk")).filter(c => c.checked);
      if (!chks.length) return alert("No videos selected.");
      if (!confirm(`Delete ${chks.length} video(s)? Cannot be undone.`)) return;

      deleteSelectedBtn.disabled = true;
      try {
        const ids = chks.map(c => c.dataset.id);
        const res = await fetch(`${BACKEND_BASE_URL}/delete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids })
        });
        const data = await res.json();
        if (data.error) {
          alert("Delete failed: " + data.error);
        } else {
          chks.forEach(c => c.closest(".video-item").remove());
          alert(`Deleted ${chks.length} video(s) successfully.`);
        }
      } catch (e) {
        alert("Failed to delete.");
      } finally {
        deleteSelectedBtn.disabled = false;
        selectAllChk.checked = false;
      }
    });

    // NEW: Delete videos older than 7 days
    deleteOldBtn.addEventListener("click", async () => {
      if (!allVideos.length) {
        return alert("Load videos first by clicking Reload.");
      }

      const now = new Date();
      const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

      const oldVideos = allVideos.filter(v => {
        if (!v.created_at) return false;
        const createdDate = new Date(v.created_at);
        return createdDate < sevenDaysAgo;
      });

      if (!oldVideos.length) {
        return alert("No videos older than 7 days found.");
      }

      if (!confirm(`Delete ${oldVideos.length} video(s) older than 7 days? This cannot be undone.`)) {
        return;
      }

      deleteOldBtn.disabled = true;
      try {
        const ids = oldVideos.map(v => v.public_id);
        const res = await fetch(`${BACKEND_BASE_URL}/delete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids })
        });
        const data = await res.json();
        if (data.error) {
          alert("Delete failed: " + data.error);
        } else {
          // Remove deleted items from UI
          ids.forEach(id => {
            const item = document.querySelector(`[data-id="${id}"]`)?.closest(".video-item");
            if (item) item.remove();
          });
          alert(`Deleted ${oldVideos.length} old video(s) successfully.`);
        }
      } catch (e) {
        alert("Failed to delete old videos.");
      } finally {
        deleteOldBtn.disabled = false;
        selectAllChk.checked = false;
      }
    });
  </script>
</body>
</html>
