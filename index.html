<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cloudinary Video Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --border: #1f2937;
      --accent: #22c55e;
      --accent-dark: #16a34a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%, #000 100%);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
    }
    .shell {
      width: 100%;
      max-width: 900px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 20px;
      border: 1px solid #111827;
      box-shadow: 0 24px 65px rgba(0, 0, 0, 0.85);
      overflow: hidden;
    }
    header {
      padding: 12px 18px;
      border-bottom: 1px solid #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 1.05rem;
      margin: 0;
    }
    header span {
      font-size: 0.7rem;
      color: var(--muted);
    }
    .chip {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #0f172a;
      color: var(--muted);
    }
    main { display: flex; min-height: 420px; }

    .sidebar {
      width: 150px;
      border-right: 1px solid #111827;
      background: #020617;
      padding: 10px 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .tab-btn {
      width: 100%;
      padding: 8px 10px;
      font-size: 0.8rem;
      border-radius: 10px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      text-align: left;
      cursor: pointer;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .tab-btn.active {
      background: #0b1120;
      border-color: #1f2937;
      color: var(--text);
    }

    .content {
      flex: 1;
      padding: 14px 16px 16px;
      background: #020617;
    }
    .hidden { display: none; }

    .row { margin-bottom: 10px; }
    label {
      font-size: 0.8rem;
      color: var(--muted);
      display: block;
      margin-bottom: 4px;
    }
    input[type="file"], input[type="password"] {
      width: 100%;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      font-size: 0.9rem;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: transform 0.1s ease, box-shadow 0.15s ease, opacity 0.15s ease;
    }
    .btn-main {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #022c22;
      box-shadow: 0 10px 28px rgba(34, 197, 94, 0.65);
    }
    .btn-secondary {
      background: #111827;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-danger {
      background: #7f1d1d;
      color: #fee2e2;
      border: 1px solid #b91c1c;
    }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; box-shadow: none; }
    .btn:not(:disabled):active { transform: translateY(1px) scale(0.99); }

    .status-box {
      margin-top: 8px;
      padding: 9px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #020617;
      font-size: 0.78rem;
    }
    .status-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #0f172a;
      color: var(--muted);
    }
    .progress {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      margin-top: 6px;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-dark));
      transition: width 0.2s ease-out;
    }

    .usage-bar {
      margin-top: 6px;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid #1f2937;
    }
    .usage-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #38bdf8, #22c55e);
      transition: width 0.25s ease-out;
    }

    .log {
      margin-top: 10px;
      max-height: 210px;
      overflow-y: auto;
      font-size: 0.78rem;
      border-top: 1px solid #111827;
      padding-top: 6px;
    }
    .log-item {
      margin-bottom: 5px;
      padding-bottom: 4px;
      border-bottom: 1px dashed #1f2937;
    }
    .log-url {
      word-break: break-all;
      color: #38bdf8;
      text-decoration: none;
    }
    .log-url:hover { text-decoration: underline; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #111827;
      text-align: left;
    }
    th { color: var(--muted); font-weight: 500; }
    tbody tr:nth-child(even) { background: #020617; }

    .thumb {
      width: 80px;
      height: 45px;
      background: #020617;
      border-radius: 6px;
      overflow: hidden;
    }
    .thumb video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #lockView {
      padding: 22px 18px 26px;
      text-align: center;
    }
    #lockView h2 { margin: 0 0 6px; font-size: 1.05rem; }
    #lockView p { margin: 0 0 14px; font-size: 0.78rem; color: var(--muted); }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <h1>Cloud Video Dashboard</h1>
        <span>Private uploader for Cloudinary (Reels folder, 25GB free)</span>
      </div>
      <span class="chip" id="authChip">Locked</span>
    </header>

    <!-- Lock screen -->
    <div id="lockView">
      <h2>Enter Access Code</h2>
      <p>This site is private. Enter your daily access code to continue.</p>
      <div class="row">
        <input id="accessInput" type="password" placeholder="Access code" />
      </div>
      <button id="unlockBtn" class="btn btn-main">Unlock</button>
      <p style="margin-top:8px;font-size:0.72rem;color:#6b7280;">
        You will stay unlocked for 24 hours on this device.
      </p>
    </div>

    <!-- App UI -->
    <main id="appView" class="hidden">
      <div class="sidebar">
        <button class="tab-btn active" data-tab="uploadTab">‚¨Ü Upload</button>
        <button class="tab-btn" data-tab="usageTab">üìä Usage</button>
        <button class="tab-btn" data-tab="manageTab">üóÇ Manage</button>
      </div>

      <div class="content">
        <!-- Upload tab -->
        <section id="uploadTab">
          <div class="row">
            <label for="fileInput">Select one or more videos</label>
            <input id="fileInput" type="file" accept="video/*" multiple />
          </div>

          <div style="display:flex; gap:8px; margin-top:6px;">
            <button id="uploadBtn" class="btn btn-main" style="flex:2;">‚¨Ü Upload</button>
            <button id="statsBtn" class="btn btn-secondary" style="flex:1;">‚Ñπ Stats</button>
          </div>

          <div class="status-box">
            <div class="status-top">
              <span id="statusText">Idle. Select videos to start.</span>
              <span id="counterBadge" class="badge">0 / 0</span>
            </div>
            <div class="progress">
              <div id="progressBar" class="progress-bar"></div>
            </div>
            <div style="margin-top:4px;font-size:0.72rem;color:#6b7280;">
              Browser total uploaded: <span id="browserTotal">0</span> videos
            </div>
          </div>

          <div class="log" id="log"></div>
        </section>

        <!-- Usage tab -->
        <section id="usageTab" class="hidden">
          <h3 style="margin:0 0 6px;font-size:0.9rem;">Storage usage</h3>
          <p style="margin:0 0 8px;font-size:0.78rem;color:#9ca3af;">
            Shows approximate Cloudinary storage used out of your 25 GB target.
          </p>
          <button id="refreshUsageBtn" class="btn btn-secondary" style="margin-bottom:8px;">
            üîÑ Refresh usage
          </button>
          <div class="status-box">
            <div class="status-top">
              <span id="usageText">Usage not loaded yet.</span>
            </div>
            <div class="usage-bar">
              <div id="usageFill" class="usage-fill"></div>
            </div>
          </div>
        </section>

        <!-- Manage tab -->
        <section id="manageTab" class="hidden">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <h3 style="margin:0;font-size:0.9rem;">Manage videos in Reels</h3>
            <button id="reloadVideosBtn" class="btn btn-secondary">üîÑ Reload</button>
          </div>
          <p style="margin:0 0 6px;font-size:0.76rem;color:#9ca3af;">
            Select videos and delete them from Cloudinary directly (this cannot be undone).
          </p>

          <div style="margin-bottom:6px;">
            <button id="deleteSelectedBtn" class="btn btn-danger">üóë Delete selected</button>
          </div>

          <div style="max-height:260px;overflow-y:auto;border:1px solid #111827;border-radius:10px;">
            <table>
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllChk" /></th>
                  <th>Preview</th>
                  <th>Size</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody id="videosBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ====== CONFIG ======
    const CLOUD_NAME = "dfnvpi7nh";
    const UPLOAD_PRESET = "telegram_upload";
    const BACKEND_BASE_URL = "https://cloudinary-video-backend.onrender.com";
    const ACCESS_CODE = "3807"; // change if you want
    const UNLOCK_HOURS = 24;
    const STORAGE_LIMIT_GB = 25;
    // ====================

    const lockView = document.getElementById("lockView");
    const appView = document.getElementById("appView");
    const accessInput = document.getElementById("accessInput");
    const unlockBtn = document.getElementById("unlockBtn");
    const authChip = document.getElementById("authChip");

    function isUnlocked() {
      const raw = localStorage.getItem("cvd_unlock");
      if (!raw) return false;
      try {
        const obj = JSON.parse(raw);
        const ts = obj.ts;
        const diffH = (Date.now() - ts) / (1000 * 60 * 60);
        return diffH < UNLOCK_HOURS;
      } catch {
        return false;
      }
    }

    function setUnlocked() {
      localStorage.setItem("cvd_unlock", JSON.stringify({ ts: Date.now() }));
    }

    function updateAuthView() {
      if (isUnlocked()) {
        lockView.classList.add("hidden");
        appView.classList.remove("hidden");
        authChip.textContent = "Unlocked";
      } else {
        lockView.classList.remove("hidden");
        appView.classList.add("hidden");
        authChip.textContent = "Locked";
      }
    }

    unlockBtn.addEventListener("click", () => {
      const val = accessInput.value.trim();
      if (!val) return alert("Enter access code.");
      if (val === ACCESS_CODE) {
        setUnlocked();
        updateAuthView();
        accessInput.value = "";
      } else {
        alert("Wrong code.");
      }
    });

    updateAuthView();

    // Upload tab
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const statsBtn  = document.getElementById("statsBtn");
    const statusText = document.getElementById("statusText");
    const counterBadge = document.getElementById("counterBadge");
    const progressBar = document.getElementById("progressBar");
    const log = document.getElementById("log");
    const browserTotalEl = document.getElementById("browserTotal");
    const globalCounterText = document.getElementById("globalCounterText");

    const LS_TOTAL_KEY = "video_uploader_total";
    let browserTotal = parseInt(localStorage.getItem(LS_TOTAL_KEY) || "0", 10);
    browserTotalEl.textContent = browserTotal;

    function saveBrowserTotal() {
      localStorage.setItem(LS_TOTAL_KEY, String(browserTotal));
      browserTotalEl.textContent = browserTotal;
    }

    function logMessage(text, url, ok = true) {
      const item = document.createElement("div");
      item.className = "log-item";
      const icon = ok ? "‚úÖ" : "‚ùå";
      item.innerHTML = `
        <div>${icon} ${text}</div>
        ${url ? `<a class="log-url" href="${url}" target="_blank">${url}</a>` : ""}
      `;
      log.prepend(item);
    }

    async function uploadSingleFile(file, index, total) {
      const endpoint = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);
      statusText.textContent = `Uploading ${index + 1} of ${total}: ${file.name}`;

      try {
        const res = await fetch(endpoint, { method: "POST", body: formData });
        if (!res.ok) {
          const errText = await res.text();
          console.error("Cloudinary error:", errText);
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        logMessage(`Uploaded: ${file.name}`, data.secure_url, true);
        browserTotal += 1;
        saveBrowserTotal();
        return true;
      } catch (err) {
        console.error(err);
        logMessage(`Failed: ${file.name} (${err.message})`, null, false);
        return false;
      }
    }

    uploadBtn.addEventListener("click", async () => {
      const files = fileInput.files;
      if (!files || files.length === 0) {
        alert("Please select at least one video file.");
        return;
      }
      if (!UPLOAD_PRESET) {
        alert("Set your unsigned upload preset name in the code.");
        return;
      }

      const total = files.length;
      let okCount = 0;
      uploadBtn.disabled = true;
      statsBtn.disabled = true;
      counterBadge.textContent = `0 / ${total}`;
      progressBar.style.width = "0%";
      statusText.textContent = `Starting upload of ${total} file(s)...`;

      for (let i = 0; i < total; i++) {
        const success = await uploadSingleFile(files[i], i, total);
        if (success) okCount++;
        const percent = Math.round(((i + 1) / total) * 100);
        progressBar.style.width = percent + "%";
        counterBadge.textContent = `${okCount} / ${total}`;
      }

      statusText.textContent =
        okCount === total
          ? `All files uploaded successfully (${okCount}/${total}).`
          : `Finished with some errors (${okCount}/${total}).`;

      uploadBtn.disabled = false;
      statsBtn.disabled = false;
    });

    statsBtn.addEventListener("click", async () => {
      try {
        const res = await fetch(`${BACKEND_BASE_URL}/stats`);
        const data = await res.json();
        if (typeof data.total === "number") {
          globalCounterText.textContent =
            `Cloud total assets: ${data.total} ‚Ä¢ Browser uploaded: ${browserTotal}`;
        } else {
          alert("Backend /stats returned invalid data.");
        }
      } catch (e) {
        console.error(e);
        alert("Failed to load stats from backend.");
      }
    });

    // Tabs
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabs = {
      uploadTab: document.getElementById("uploadTab"),
      usageTab: document.getElementById("usageTab"),
      manageTab: document.getElementById("manageTab")
    };

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.tab;
        Object.keys(tabs).forEach(k => {
          tabs[k].classList.toggle("hidden", k !== target);
        });
        tabButtons.forEach(b => b.classList.toggle("active", b === btn));
      });
    });

    // Usage tab
    const refreshUsageBtn = document.getElementById("refreshUsageBtn");
    const usageText = document.getElementById("usageText");
    const usageFill = document.getElementById("usageFill");

    refreshUsageBtn.addEventListener("click", async () => {
      refreshUsageBtn.disabled = true;
      try {
        const res = await fetch(`${BACKEND_BASE_URL}/usage`);
        const data = await res.json();
        const used = data.storageGB || 0;
        const limit = data.limitGB || STORAGE_LIMIT_GB;
        const percent = Math.min(100, (used / limit) * 100);
        usageFill.style.width = `${percent.toFixed(1)}%`;
        const left = Math.max(0, limit - used);
        usageText.textContent =
          `Used ${used.toFixed(2)} GB of ${limit} GB (${percent.toFixed(1)}%). ` +
          `Approx left: ${left.toFixed(2)} GB.`;
      } catch (e) {
        console.error(e);
        alert("Failed to load usage.");
      } finally {
        refreshUsageBtn.disabled = false;
      }
    });

    // Manage tab
    const videosBody = document.getElementById("videosBody");
    const reloadVideosBtn = document.getElementById("reloadVideosBtn");
    const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
    const selectAllChk = document.getElementById("selectAllChk");

    function formatBytes(b) {
      if (!b) return "0 MB";
      const mb = b / (1024 * 1024);
      return `${mb.toFixed(1)} MB`;
    }

    function renderVideos(videos) {
      videosBody.innerHTML = "";
      videos.forEach(v => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="checkbox" class="rowChk" data-id="${v.public_id}" /></td>
          <td>
            <div class="thumb">
              <video src="${v.secure_url}" muted></video>
            </div>
          </td>
          <td>${formatBytes(v.bytes)}</td>
          <td>${v.created_at ? v.created_at.replace("T", " ").slice(0, 16) : ""}</td>
        `;
        videosBody.appendChild(tr);
      });
    }

    reloadVideosBtn.addEventListener("click", async () => {
      reloadVideosBtn.disabled = true;
      try {
        const res = await fetch(`${BACKEND_BASE_URL}/videos`);
        const data = await res.json();
        renderVideos(data.videos || []);
      } catch (e) {
        console.error(e);
        alert("Failed to load videos.");
      } finally {
        reloadVideosBtn.disabled = false;
        selectAllChk.checked = false;
      }
    });

    selectAllChk.addEventListener("change", () => {
      const chks = document.querySelectorAll(".rowChk");
      chks.forEach(c => (c.checked = selectAllChk.checked));
    });

    deleteSelectedBtn.addEventListener("click", async () => {
      const chks = Array.from(document.querySelectorAll(".rowChk"))
        .filter(c => c.checked);
      if (!chks.length) {
        alert("No videos selected.");
        return;
      }
      if (!confirm(`Delete ${chks.length} video(s) from Cloudinary? This cannot be undone.`)) {
        return;
      }
      deleteSelectedBtn.disabled = true;
      try {
        const ids = chks.map(c => c.dataset.id);
        const res = await fetch(`${BACKEND_BASE_URL}/delete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids })
        });
        const data = await res.json();
        if (data.error) {
          alert("Delete failed: " + data.error);
        } else {
          chks.forEach(c => c.closest("tr").remove());
        }
      } catch (e) {
        console.error(e);
        alert("Failed to delete videos.");
      } finally {
        deleteSelectedBtn.disabled = false;
        selectAllChk.checked = false;
      }
    });
  </script>
</body>
</html>
